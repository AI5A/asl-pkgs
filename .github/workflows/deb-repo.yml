# NOTE: This file is generated by generate-workflow.py
# Do not edit this file directly.

name: Generate deb repository
'on':
  push: {}
  workflow_dispatch: {}
jobs:
  generate-deb-repository:
    name: Generate deb repository
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      fail-fast: false
    steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Download asl-dahdi-bullseye-x86_64
      uses: dawidd6/action-download-artifact@v2
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        workflow: build-x86.yml
        name: asl-dahdi-bullseye-x86_64
        path: asl-dahdi-bullseye-x86_64
        repo: AI5A/asl-dahdi
        branch: fixes
        workflow_conclusion: success
    - name: Download asl-dahdi-buster-x86_64
      uses: dawidd6/action-download-artifact@v2
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        workflow: build-x86.yml
        name: asl-dahdi-buster-x86_64
        path: asl-dahdi-buster-x86_64
        repo: AI5A/asl-dahdi
        branch: fixes
        workflow_conclusion: success
    - name: Download asl-dahdi-bullseye-armv7l
      uses: dawidd6/action-download-artifact@v2
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        workflow: build-arm.yml
        name: asl-dahdi-bullseye-armv7l
        path: asl-dahdi-bullseye-armv7l
        repo: AI5A/asl-dahdi
        branch: fixes
        workflow_conclusion: success
    - name: Download asl-dahdi-buster-armv7l
      uses: dawidd6/action-download-artifact@v2
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        workflow: build-arm.yml
        name: asl-dahdi-buster-armv7l
        path: asl-dahdi-buster-armv7l
        repo: AI5A/asl-dahdi
        branch: fixes
        workflow_conclusion: success
    - name: Download allstarlink-bullseye-x86_64
      uses: dawidd6/action-download-artifact@v2
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        workflow: build-x86.yml
        name: allstarlink-bullseye-x86_64
        path: allstarlink-bullseye-x86_64
        repo: AI5A/asl
        branch: fixes
        workflow_conclusion: success
    - name: Download allstarlink-buster-x86_64
      uses: dawidd6/action-download-artifact@v2
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        workflow: build-x86.yml
        name: allstarlink-buster-x86_64
        path: allstarlink-buster-x86_64
        repo: AI5A/asl
        branch: fixes
        workflow_conclusion: success
    - name: Download allstarlink-bullseye-armv7l
      uses: dawidd6/action-download-artifact@v2
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        workflow: build-arm.yml
        name: allstarlink-bullseye-armv7l
        path: allstarlink-bullseye-armv7l
        repo: AI5A/asl
        branch: fixes
        workflow_conclusion: success
    - name: Download allstarlink-buster-armv7l
      uses: dawidd6/action-download-artifact@v2
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        workflow: build-arm.yml
        name: allstarlink-buster-armv7l
        path: allstarlink-buster-armv7l
        repo: AI5A/asl
        branch: fixes
        workflow_conclusion: success
    - name: Download asl-update-node-list-bullseye
      uses: dawidd6/action-download-artifact@v2
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        workflow: build.yml
        name: asl-update-node-list-bullseye
        path: asl-update-node-list-bullseye
        repo: AI5A/asl-update-node-list
        branch: fixes
        workflow_conclusion: success
    - name: Download asl-update-node-list-buster
      uses: dawidd6/action-download-artifact@v2
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        workflow: build.yml
        name: asl-update-node-list-buster
        path: asl-update-node-list-buster
        repo: AI5A/asl-update-node-list
        branch: fixes
        workflow_conclusion: success
    - name: Import GPG key
      uses: crazy-max/ghaction-import-gpg@v5
      with:
        gpg_private_key: ${{ secrets.GPG_SECRET_KEY }}
        passphrase: ${{ secrets.GPG_PASSPHRASE }}
    - name: Install dependencies
      run: sudo apt-get install -y gcc dpkg-dev gpg
    - name: Move debs
      run: "\nrepo=\"$(pwd)\"\nfor codename in bullseye buster; do\n    # Create pool\
        \ directory\n    mkdir -p asl-pkgs/deb/$codename/pool/main/\n    # Move the\
        \ debs\n    pushd asl-pkgs/deb/$codename/pool/main/\n    for pkg in asl-dahdi\
        \ allstarlink asl-update-node-list; do\n        for file in $repo/$pkg-$codename*/*.deb;\
        \ do\n            mv -v $file .\n        done\n    done\n    popd\n\n    #\
        \ Create dist hierarchy\n    pushd asl-pkgs/deb/$codename/\n    for arch in\
        \ amd64 armhf; do\n        mkdir -p dists/$codename/main/binary-$arch/\n \
        \       dpkg-scanpackages --arch $arch pool/main/ > dists/$codename/main/binary-$arch/Packages\n\
        \    done\n    popd\n\n    # Create Release file\n    pushd asl-pkgs/deb/$codename/\n\
        \      bash $repo/generate-release.sh $codename > Release\n      gpg --armour\
        \ --sign --detach-sign --output Release.gpg Release\n      mv -v Release.gpg\
        \ Release dists/$codename/\n    popd\ndone\n"
    - name: Generate indexes
      run: '

        curl -o gen-indexes.py https://raw.githubusercontent.com/relrod/oneoff/master/generate-html-indexes.py

        find asl-pkgs > files-list.txt

        cat files-list.txt

        cat files-list.txt | python3 gen-indexes.py .

        tree .

        '
    - name: Push to GitHub Pages
      uses: JamesIves/github-pages-deploy-action@v4
      with:
        folder: asl-pkgs
        clean: false

